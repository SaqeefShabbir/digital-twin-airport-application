<div class="flight-operations-container" #operationsContainer>
  <!-- Header -->
  <div class="operations-header">
    <h2 class="header-title">
      <mat-icon class="header-icon">flight</mat-icon>
      Flight Operations
      <span class="subtitle">{{viewMode | titlecase}} View</span>
    </h2>
    
    <div class="header-controls">
      <button mat-raised-button 
              color="primary" 
              (click)="refreshData()"
              [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        {{isLoading ? 'Loading...' : 'Refresh'}}
      </button>
      
      <button mat-button 
              (click)="onToggleAutoRefresh()"
              [color]="autoRefresh ? 'accent' : ''">
        <mat-icon>{{autoRefresh ? 'toggle_on' : 'toggle_off'}}</mat-icon>
        Auto-refresh
      </button>
      
      <button mat-button (click)="onToggleFilters()">
        <mat-icon>{{showFilters ? 'filter_alt' : 'filter_alt_off'}}</mat-icon>
        Filters
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-container">
    <div class="stat-card" [class.active]="statusFilter === 'ALL'">
      <div class="stat-value">{{stats.totalFlights}}</div>
      <div class="stat-label">Total Flights</div>
    </div>
    
    <div class="stat-card" [class.active]="operationTypeFilter === 'ARRIVAL'">
      <mat-icon class="stat-icon">flight_land</mat-icon>
      <div class="stat-value">{{stats.arrivals}}</div>
      <div class="stat-label">Arrivals</div>
    </div>
    
    <div class="stat-card" [class.active]="operationTypeFilter === 'DEPARTURE'">
      <mat-icon class="stat-icon">flight_takeoff</mat-icon>
      <div class="stat-value">{{stats.departures}}</div>
      <div class="stat-label">Departures</div>
    </div>
    
    <div class="stat-card" [class.active]="statusFilter === 'ON_TIME'">
      <mat-icon class="stat-icon">schedule</mat-icon>
      <div class="stat-value">{{stats.onTime}}</div>
      <div class="stat-label">On Time</div>
    </div>
    
    <div class="stat-card" [class.active]="statusFilter === 'DELAYED'">
      <mat-icon class="stat-icon">warning</mat-icon>
      <div class="stat-value">{{stats.delayed}}</div>
      <div class="stat-label">Delayed</div>
    </div>
    
    <div class="stat-card" [class.active]="statusFilter === 'CANCELLED'">
      <mat-icon class="stat-icon">cancel</mat-icon>
      <div class="stat-value">{{stats.cancelled}}</div>
      <div class="stat-label">Cancelled</div>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="filters-panel" *ngIf="showFilters">
    <div class="filters-row">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search flights</mat-label>
        <input matInput 
               [(ngModel)]="searchQuery" 
               (ngModelChange)="onSearch()"
               placeholder="Flight number, airline, destination...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Time Period Selector -->
      <mat-form-field appearance="outline">
        <mat-label>Time Period</mat-label>
        <mat-select [(value)]="selectedTimePeriod" (selectionChange)="onTimePeriodChange()">
          <mat-option *ngFor="let period of timePeriods" [value]="period.value">
            {{period.label}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Status Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(value)]="statusFilter" (selectionChange)="onFilterChange()">
          <mat-option value="ALL">All Status</mat-option>
          <mat-option value="SCHEDULED">Scheduled</mat-option>
          <mat-option value="ON_TIME">On Time</mat-option>
          <mat-option value="BOARDING">Boarding</mat-option>
          <mat-option value="IN_FLIGHT">In Flight</mat-option>
          <mat-option value="LANDED">Landed</mat-option>
          <mat-option value="DELAYED">Delayed</mat-option>
          <mat-option value="CANCELLED">Cancelled</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Operation Type Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Operation Type</mat-label>
        <mat-select [(value)]="operationTypeFilter" (selectionChange)="onFilterChange()">
          <mat-option value="ALL">All Operations</mat-option>
          <mat-option value="ARRIVAL">Arrivals</mat-option>
          <mat-option value="DEPARTURE">Departures</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Terminal Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Terminal</mat-label>
        <mat-select [(value)]="terminalFilter" (selectionChange)="onFilterChange()">
          <mat-option value="ALL">All Terminals</mat-option>
          <mat-option *ngFor="let terminal of terminals" [value]="terminal">
            Terminal {{terminal}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Clear Filters Button -->
      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>clear_all</mat-icon>
        Clear Filters
      </button>
    </div>

    <!-- Show Only Delays Toggle -->
    <div class="filter-toggle">
      <mat-slide-toggle [(ngModel)]="showOnlyDelays" (change)="loadFlights()">
        Show Only Delayed Flights
      </mat-slide-toggle>
    </div>
  </div>

  <!-- Flight Operations Table -->
  <div class="operations-table-container">
    <div class="table-header">
      <div class="results-info">
        Showing {{filteredFlights.length}} of {{stats.totalFlights}} flights
        <span *ngIf="selectedTimePeriod">
          (Next {{selectedTimePeriod}} minutes)
        </span>
      </div>
      <div class="last-updated" *ngIf="!isLoading">
        Last updated: {{formatDateTime(currentDate)}}
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Loading flight data...</span>
    </div>

    <!-- No Results State -->
    <div class="no-results" *ngIf="!isLoading && filteredFlights.length === 0">
      <mat-icon>airplanemode_inactive</mat-icon>
      <h3>No flights found</h3>
      <p>Try adjusting your filters or search criteria</p>
    </div>

    <!-- Flight Table -->
    <div class="table-responsive" *ngIf="!isLoading && filteredFlights.length > 0">
      <table class="flight-table">
        <thead>
          <tr>
            <th (click)="onSort('flightNumber')" class="sortable">
              Flight
              <mat-icon>{{sortField === 'flightNumber' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('airline')" class="sortable">
              Airline
              <mat-icon>{{sortField === 'airline' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('operationType')" class="sortable">
              Operation
              <mat-icon>{{sortField === 'operationType' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('origin')" class="sortable">
              Route
              <mat-icon>{{sortField === 'origin' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('scheduledTime')" class="sortable">
              Scheduled
              <mat-icon>{{sortField === 'scheduledTime' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('actualTime')" class="sortable">
              Actual
              <mat-icon>{{sortField === 'actualTime' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th (click)="onSort('status')" class="sortable">
              Status
              <mat-icon>{{sortField === 'status' ? (sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward') : 'unfold_more'}}</mat-icon>
            </th>
            <th>Gate</th>
            <th>Terminal</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let flight of filteredFlights" 
              [class.selected]="selectedFlight?.flightNumber === flight.flightNumber"
              [class.delayed]="flight.status === 'DELAYED'"
              [class.cancelled]="flight.status === 'CANCELLED'"
              (click)="onFlightSelect(flight)">
            <td class="flight-number">
              <mat-icon class="flight-icon">{{getOperationTypeIcon(flight.operationType)}}</mat-icon>
              <strong>{{flight.flightNumber}}</strong>
            </td>
            <td class="airline">
              <img *ngIf="flight.airlineLogo" [src]="flight.airlineLogo" [alt]="flight.airline" class="airline-logo">
              {{flight.airline}}
            </td>
            <td>
              <span class="operation-badge" [class.arrival]="flight.operationType === 'ARRIVAL'">
                {{flight.operationType}}
              </span>
            </td>
            <td class="route">
              <span class="origin">{{flight.origin}}</span>
              <mat-icon class="route-arrow">arrow_right_alt</mat-icon>
              <span class="destination">{{flight.destination}}</span>
            </td>
            <td class="time-cell">
              {{formatTime(flight.scheduledTime)}}
            </td>
            <td class="time-cell">
              {{flight.actualTime ? formatTime(flight.actualTime) : '--:--'}}
              <span *ngIf="flight.status === 'DELAYED'" class="delay-badge">
                +{{getDelayMinutes(flight)}}m
              </span>
            </td>
            <td>
              <span class="status-badge" [class]="getStatusClass(flight.status)">
                {{flight.status.replace('_', ' ')}}
              </span>
            </td>
            <td class="gate-cell">
              {{flight.gate || '--'}}
            </td>
            <td class="terminal-cell">
              {{flight.terminal || '--'}}
            </td>
            <td class="actions-cell">
              <button mat-icon-button (click)="onFlightSelect(flight); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button *ngIf="flight.status === 'DELAYED'">
                <mat-icon>warning</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Selected Flight Details Panel -->
  <div class="details-panel" *ngIf="selectedFlight">
    <div class="details-header">
      <h3>Flight Details</h3>
      <button mat-icon-button (click)="selectedFlight = null">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="details-content">
      <div class="detail-row">
        <div class="detail-label">Flight Number</div>
        <div class="detail-value">{{selectedFlight.flightNumber}}</div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Airline</div>
        <div class="detail-value">{{selectedFlight.airline}}</div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Route</div>
        <div class="detail-value">
          {{selectedFlight.origin}} â†’ {{selectedFlight.destination}}
        </div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Scheduled Time</div>
        <div class="detail-value">{{formatDateTime(selectedFlight.scheduledTime)}}</div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Actual Time</div>
        <div class="detail-value">
          {{selectedFlight.actualTime ? formatDateTime(selectedFlight.actualTime) : '--'}}
          <span *ngIf="selectedFlight.status === 'DELAYED'" class="delay-text">
            (Delayed by {{getDelayMinutes(selectedFlight)}} minutes)
          </span>
        </div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Status</div>
        <div class="detail-value">
          <span class="status-badge" [class]="getStatusClass(selectedFlight.status)">
            {{selectedFlight.status.replace('_', ' ')}}
          </span>
        </div>
      </div>
      
      <div class="detail-row">
        <div class="detail-label">Terminal / Gate</div>
        <div class="detail-value">
          {{selectedFlight.terminal || '--'}} / {{selectedFlight.gate || '--'}}
        </div>
      </div>
      
      <div class="detail-row" *ngIf="selectedFlight.baggageClaim">
        <div class="detail-label">Baggage Claim</div>
        <div class="detail-value">{{selectedFlight.baggageClaim}}</div>
      </div>
      
      <div class="detail-row" *ngIf="selectedFlight.remarks">
        <div class="detail-label">Remarks</div>
        <div class="detail-value">{{selectedFlight.remarks}}</div>
      </div>
    </div>
  </div>
</div>